<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hello Bulma!</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
  <style>
    .is-hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="modal" id="generalModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title" id="generalModal-title">Trigger Information</p>
      </header>
      <section class="modal-card-body" id="generalModal-description">
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" onclick="closeModal()">Close</button>
      </footer>
    </div>
  </div>
  
  <section class="section">
    <div class="container">
      <h1 class="title">
        Monito
      </h1>
      <p class="subtitle">
        Monitoring framework
        <div id="serverinfo">
          <p>Server Name: <span id="server-name">Login first.</span></p>
        </div>
      </p>
      </div>
  </section>
  <div id="login-page" class="container form">
    <input type="text field" name="code" id="code" class="is-warning input" placeholder="Secret Code"><br><br>
    <button class="is-warning button field" onclick="login()">Login</button>
  </div>
  <div id="main-page" class="container is-hidden">
    <div>
      <div id="tabs" class="tabs">
        <ul>
          <li class="is-active"><a onclick="switchTo('Logs')">Logs</a></li>
          <li><a onclick="switchTo('Triggers')">Triggers</a></li>
          <li><a onclick="switchTo('Settings')">Settings</a></li>
        </ul>
      </div>
      <div class="tab-contents Logs-tabcontents">
        <div class="title is-4 mt-5">
          Logs
        </div>
        <button id="EnableCompactMode" class="button is-success" onclick="ToggleCompactMode()">Enable Compact Mode</button>
        <div id="logs">

        </div>
      </div>
      <div id="triggers" class="tab-contents Triggers-tabcontents">
        
      </div>
      <div id="settings" class="tab-contents Settings-tabcontents">
        <header class="title is-3">Extensions</header>
        <div id="extensions-list">

        </div>
      </div>
    </div>
  </div>
  <br><br>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/modallib.js"></script>
  <script src="/js/tabs.js"></script>
  <script src="/js/triggers.js"></script>

  <script>
    function escapeOutput(toOutput){
        return toOutput.replace(/\&/g, '&amp;')
            .replace(/\</g, '&lt;')
            .replace(/\>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#x27')
            .replace(/\//g, '&#x2F');
    }

    var socket = io();

    var damntriggers = {}
    var logs = []
    var code

    var compactMode = false

    function ToggleCompactMode() {
      compactMode = !compactMode
      if (compactMode) document.getElementById("EnableCompactMode").innerText = `Disable Compact Mode`
      else document.getElementById("EnableCompactMode").innerText = `Enable Compact Mode`
      renderLogs(compactMode)
    }

    fetch("/api/isinstalled").then( a => a.json() ).then(({data}) => {
      if (!data) {
        document.location = "/setup.html"
      }
    })

    function login() {
      code = document.getElementById("code").value
      fetch("/api/info?code=" + code).then(a => a.json()).then(data => {
      if (data.error) {
        alert("code is bad!")
      } else {

        fetch("/api/extensions?code=" + code).then(a => a.json()).then(({data}) => {
          data.forEach(ext => {
            document.getElementById("extensions-list").innerHTML += `

            - ${ext.name}: ${ext.description} (author: ${ext.author})<br>
          
          `
          })
        })

        document.getElementById("server-name").innerText = data.server.name
        document.getElementById("main-page").classList.remove("is-hidden")
        document.getElementById("login-page").classList.add("is-hidden")
        socket.emit("login", code)
        renderLogs(compactMode)
        startListening()

      }
      })
      
    }

    function startListening() {
      fetch("/api/triggers/?code=" + code).then(a => a.json()).then(data => {
        console.log(data.data)
        renderTriggers(data.data)
        damntriggers = data.data
        socket.emit("sendAllLogs")
      })

      socket.on("trigger", ({
        trigger,
        id,
        data
      }) => {
        if (Object.keys(damntriggers).includes(trigger)) {
          logs.push({
            trigger,
            id,
            data
          })
          
          console.log(id)
          renderLogs(compactMode)
        }
      })
    }

    async function deleteLog(id) {
      const req = await fetch("/api/deletelog", {
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
        headers: {
          'Content-Type': 'application/json'
          // 'Content-Type': 'application/x-www-form-urlencoded',
        },
        redirect: 'follow', // manual, *follow, error
        referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        body: JSON.stringify({
          id,
          code
        }) // body data type must match "Content-Type" header
      })
      const response = await req.json()
      logs = response.data
      renderLogs(compactMode) 

    }

    function info(trigger) {
      (new Modal("Trigger Information - " + trigger, damntriggers[trigger].description)).show()
    }

    function renderLogs(compactMode) {
      if (!compactMode) {
        document.getElementById("logs").innerHTML = ""
        
        logs.forEach(({
          trigger,
          id,
          data
        }) => {
          document.getElementById("logs").innerHTML = `
                <br><div class="card">
                    <div class="card-content">
                        <div class="tag is-${escapeOutput(damntriggers[trigger].type)}">${escapeOutput(damntriggers[trigger].type.toUpperCase())}</div><b> ${escapeOutput(damntriggers[trigger].name)} Trigger Hit (${id})</b><br><br>
                        <b>Trigger Description:</b> ${escapeOutput(damntriggers[trigger].description)}<br>
                        <br><b>Captured Data:</b> ${escapeOutput(data)}<br><br>
                        <button onclick="deleteLog('${id}')" class="is-danger button is-small">DELETE</button>
                        </div>
                </div>
                ${document.getElementById("logs").innerHTML}
                ` 
          
        })
      } else {
        document.getElementById("logs").innerHTML = `<br><br>
        <table class="table">
  <thead>
    <tr>
      <th>Trigger</th>
      <th>Data</th>
      <th>Controls</th>
    </tr>
  </thead>
  <tbody>
    ${(() => {
      var tbody = ``
      logs.forEach(({trigger,id,data}) => {
        tbody += `
        <tr>
          <th>${escapeOutput(trigger)} <span class="has-text-${escapeOutput(damntriggers[trigger].type)}">${escapeOutput(damntriggers[trigger].type).toUpperCase()}</span></th>
          <td>${escapeOutput(data)}</td>
          <td>
            <button class="is-small button is-danger" onclick="deleteLog('${id}')">X</button>
            <button class="is-small button is-info" onclick="info('${trigger}')">i</button>
          </td>
        </tr>
        `
      })
      return tbody
    })()}

    </tbody>
    </table>
        `


      }
    }
  </script>

</body>

</html>